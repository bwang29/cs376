<html>
<head>
  <link href='http://fonts.googleapis.com/css?family=Titillium+ Web|Noto+Sans|Noto+Serif|Roboto+Condensed' rel='stylesheet' type='text/css'>
  <script src="js/jquery-1.9.0.min.js"></script>
  <script src="js/best_songs.js"></script> 
  <script src="js/color-0.4.1.min.js"></script>
  <script src="analysis.js"></script>
  <style type="text/css">
  body{
    font-family: "Titillium Web";
  }
  .little{
    display: inline-block;
    /*border-left: 2px solid #fff;*/
    width: 20px;
    height: 150px;
  }
  .one_cell{
    display: inline-block;
    width: 242px;
    margin: 10px;
    padding: 10px;
    border: 1px solid #efefef;
  }
  .cell{
    display: inline-block;
    width: 50px;
    height: 50px;
    color: white;
    font-size: 40px;
  }
  </style>
</head>
<body>
  <script>
    var total_room_created = 0;
    var total_game_started = 0;
    var total_song_pairs = 0;
    var song_key_map = {};
    var song_key_array = [];
    var simple_color = ["#ffa7a4","#ffd8aa","#fffba6","#d6ea98","#91e5c4","#a5bae2","#c6abdf","#e9a2cf","#f2f2f2","#ff2400","#ff8e00","#fffb00","#89c300","#00b366","#0063b3","#5f20a0","#c82378","#666666","#7d2000","#7d4700","#7c7800","#445d00","#005834","#003259","#411166","#610e3d","#111111"];

    var simple_color_map = {};
    for(var i=0; i<simple_color.length; i++){
      simple_color_map[simple_color[i]] = {count:0};
    }

    for(var i=0;i< best_songs.length; i++){
      song_key_map[best_songs[i]] = {cprs:[],color:[],room_count:0};
    }

    for(var key in data.rooms){
      total_room_created += 1;
      if(data.rooms[key].game_started){
        total_game_started += 1;
      }
      for(var i=0; i<=5 ;i++){
        analyze_song_pairs(key,i);
      }
    }

    // convert hash into an array
    for(key in song_key_map){
      song_key_array.push([key,song_key_map[key]]);
    }
    // sort array by room count
    song_key_array.sort(function(a,b){
      return b[1].room_count - a[1].room_count;
    });
    
    // print result
    $(document).ready(function(){
      for(var j=0; j<song_key_array.length; j++){
          song_key_array[j][1].color.sort(function(a,b){ return getColorSig(a)-getColorSig(b)});
          var html = "<div class='one_cell'>" + song_key_array[j][0].replace("  "," - ")+"<br/>";
          for(var i=0; i< song_key_array[j][1].color.length; i++){
            html+= ("<div class='little' style='width:"+ 100/song_key_array[j][1].color.length + "%; background:"+song_key_array[j][1].color[i]+"'></div>");
            simple_color_map[song_key_array[j][1].color[i]].count ++;
          }
          html+= ("</div>");
          $("#songs").append(html);
      }
      for(key in simple_color_map){
        var html = "<div class='cell' style='background:"+key+"; width:"+3*simple_color_map[key].count+"px'>"+ simple_color_map[key].count + "</div>";
        $("#cells").append(html);
      }
    });

    function analyze_song_pairs(k,r){
      if(data.rooms[k][r]){
        total_song_pairs += 1;
        for(song in song_key_map){
          if(song.indexOf(data.rooms[k][r].t) != -1 && song.indexOf(data.rooms[k][r].a) != -1){
            song_key_map[song].cprs.push(data.rooms[k][r]);
            song_key_map[song].color.push(data.rooms[k][r][1]);
            song_key_map[song].color.push(data.rooms[k][r][2]);
            song_key_map[song].room_count ++;
          }
        }
      }
    }

    // color #xxxxxx
    function getColorSig(color) {
      var r = parseInt(color.substring(1,3),16);
      var g = parseInt(color.substring(3,5),16);
      var b = parseInt(color.substring(5,7),16);
      return parseFloat(rgbToHsl(r, g, b)[0] * 360);
    }

    function rgbToHsl(r, g, b){
      r /= 255, g /= 255, b /= 255;
      var max = Math.max(r, g, b), min = Math.min(r, g, b);
      var h, s, l = (max + min) / 2;
      if(max == min){
          h = s = 0; // achromatic
      }else{
          var d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch(max){
              case r: h = (g - b) / d + (g < b ? 6 : 0); break;
              case g: h = (b - r) / d + 2; break;
              case b: h = (r - g) / d + 4; break;
          }
          h /= 6;
      }
      return [h, s, l];
    }

    function get_root_url(){
      return window.location.href.split("analysis.html")[0];
    }

  </script>
  <h1> Color labeling of 102 songs <button onclick="window.location.href=get_root_url()">Try out the game!</button></h1>
  <div id="songs"></div>
  <div id="cells" style="width:900px"></div>
</body>
</html>